<link rel="stylesheet" type="text/css" href="/auto-number.css">

# 性能调优

## CPU性能

### 平均负载

#### 平均负载的概念

系统平均负载指的是一段时间内处于`可运行状态（Running 或 Runnable）`和`不可中断状态（Uninterruptible）`的进程数的平均值。


* `可运行状态`的进程可能是CPU正在运行的进程，也可能是随时可以被调度执行的程序。
* `不可中断状态`的进程通常是进程在与外部设备交互，为了保证交互的正常进行，交互过程不能被打断，因而处于不可中断状态；
该状态下，进程不会接收和处理`信号（signal）`，即使是`kill -9`和`kill -15`也不能杀死该状态的进程。

系统平均负载不同于CPU利用率，CPU利用率指的是某个时间，CPU的繁忙与空闲程度。对于I/O密集型的应用，可能出现平均负载很高，
但是CPU利用率却不高的情况，因为I/O密集型的应用，可能很多进程因为在等待外部设备的响应而处于`不可中断状态`，这时候CPU
并没有多少进程可执行，因此，CPU利用率不高。


有三种情况可能导致系统平均负载升高：
* CPU密集型的应用：应用本身有大量的计算要执行，执行的过程中，需要不断的占用CPU资源；
* I/O密集型的应用：应用需要和外部设备进行大量的交互，导致进程处于`不可中断状态`，此时系统负载高，但是CPU利用率可能较低；
* 混合型的应用：系统中有大量处于`可运行状态`的进程，因为进程的调度和频繁的切换也会消耗大量的CPU资源；

#### 查看平均负载

##### 查看系统平均负载

```bash
# 查看系统最近1、5、15分钟的平均负载
$ uptime
07:43:20 up  2:32,  3 users,  load average: 0.00, 0.00, 0.26
```
`uptime`输出的最后三个数就代表系统最近1分钟、5分钟、15分钟的平均负载。

##### 查看每个CPU的利用率

对于多核的系统，mpstat可以方便的查看所有CPU的利用率。具体如下：

```bash
# 以5秒的间隔显示所有CPU的利用率
# mpstat -P ALL 5
Linux 4.15.0-65-generic (perf1)         01/29/2020      _x86_64_        (2 CPU)

01:02:28 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
01:02:33 PM  all    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
01:02:33 PM    0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
01:02:33 PM    1    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
^C

Average:     CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
Average:     all    0.00    0.00    0.03    0.00    0.00    0.00    0.00    0.00    0.00   99.97
Average:       0    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
Average:       1    0.00    0.00    0.07    0.00    0.00    0.00    0.00    0.00    0.00   99.93
```
mpstat输出的CPU利用率各个字段的含义如下：
* CPU：all表示所有CPU的总体统计情况，数字是CPU核的编号（从0开始），表示单个核的统计情况；
* %usr：表示CPU处于用户态的时间比例；
* %nice：表示CPU处于用户态且由于nice优先权的时间比例；
* %sys：表示CPU处于内核态的时间比例；
* %iowait：表示CPU因为等待I/O而空闲的时间比例；
* %irq：表示CPU处理硬件中断的时间比例；
* %soft：表示CPU处理软中断的时间比例；
* %steal：在虚拟化情况下，表示因为等待hypervisor而非自愿等待的时间占比；
* %guest：在虚拟化情况下，表示CPU处于虚拟化状态的时间占比；
* %gnice：在虚拟化情况下，表示CPU处于niced虚拟化状态的时间占比；
* %idle：表示CPU处于空闲状态的时间比例；

##### 查看近期占用CPU较多的进程

mpstat输出的是单个或所有CPU的统计信息，在排查性能问题时，肯定需要具体到某个进程，
因此，获得近期占用CPU最多的进程的工具十分有必要。`pidstat`就是这样的一个工具。

```bash
# 显示最近5秒钟占用CPU最多的进程
# pidstat -u 5 1
Linux 4.15.0-65-generic (perf1)         01/29/2020      _x86_64_        (2 CPU)

01:36:23 PM   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
01:36:28 PM     0     20457    0.20    0.20    0.00    0.00    0.40     0  top
01:36:28 PM     0     20465    0.00    0.20    0.00    0.00    0.20     1  pidstat

Average:      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
Average:        0     20457    0.20    0.20    0.00    0.00    0.40     -  top
Average:        0     20465    0.00    0.20    0.00    0.00    0.20     -  pidstat
```
pidstat输出的近期CPU利用率各字段的含义如下：
* UID：启动进程的用户的ID
* PID：进程的ID
* %usr：进程处于用户态（不包括处于虚拟化状态）的时间占比；
* %system：进程处于内核态的时间占比；
* %guest：进程处于虚拟化模式的时间占比；
* %wait：进程处于等待执行状态的时间占比；
* %CPU：进程总的CPU利用率；
* CPU：运行进程的CPU核心的编号


## 内存性能

## I/O性能

## 网络性能
